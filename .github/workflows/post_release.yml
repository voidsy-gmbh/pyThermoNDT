name: Post-Release Workflow

on:
  release:
    types: [published]

jobs:
  # Job 1: Build the package
  build-package:
    name: Build Package
    uses: ./.github/workflows/build.yml
    with:
      ref: ${{ github.event.release.tag_name }}

  # Job 2: Publish to PyPI (runs parallel with sign-and-upload)
  publish-pypi:
    name: Publish to PyPI
    needs: build-package
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/pythermondt
    permissions:
      id-token: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v5.0.0
        with:
          name: build-artifacts
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  # Job 3: Sign and upload release assets
  gh-release-assets:
    name: Sign and Upload Release Assets
    needs: build-package
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v5.0.0
        with:
          name: build-artifacts
          path: dist/

      - name: Sign artifacts and upload to GitHub Release
        uses: sigstore/gh-action-sigstore-python@v3.1.0
        with:
          inputs: |
            ./dist/*.tar.gz
            ./dist/*.whl

  # Job 4: Bump the version in the main branch to the next patch version
  bump-version:
    name: Bump Version to Next Patch
    needs: [publish-pypi, gh-release-assets]
    uses: ./.github/workflows/bump_version.yml
    with:
      bump-type: patch
      ref: main
    secrets:
      WRITE_KEY: ${{ secrets.WRITE_KEY }}
