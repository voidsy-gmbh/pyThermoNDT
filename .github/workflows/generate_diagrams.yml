name: Generate Diagrams

on:
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all images (even if no .mmd files changed)'
        required: false
        default: false
        type: boolean

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    env:
      CHANGED: false
      MERMAID_DIR: ./docs/pyreverse/mermaid
      IMAGES_DIR: ./docs/pyreverse/images

    steps:
    - name: Checkout code
      uses: actions/checkout@v4.2.2
      with:
        ssh-key: ${{ secrets.WRITE_KEY }}

    - name: Set up Python 3.12
      uses: astral-sh/setup-uv@v6.3.1
      with:
        python-version: ${{ vars.DEFAULT_PYTHON_VERSION }}
        activate-environment: true
        enable-cache: false

    - name: Install dependencies
      run: |
        uv pip install git+https://github.com/Julfried/pylint.git@fix-agg-comp

    - name: Create directories for diagrams
      run: |
        mkdir -p ${{ env.MERMAID_DIR }}
        mkdir -p ${{ env.IMAGES_DIR }}

    - name: Generate Mermaid files for all major modules with Pyreverse
      run: |
        # Generate a top level overview of the project
        pyreverse -p Overview -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src --max-depth 1 pythermondt

        # Generate detailed diagrams for all major modules
        pyreverse -p pythermondt -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt
        pyreverse -p pythermondt.data -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt.data
        pyreverse -p pythermondt.dataset -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt.dataset
        pyreverse -p pythermondt.readers -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt.readers
        pyreverse -p pythermondt.transforms -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt.transforms
        pyreverse -p pythermondt.writers -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt.writers
        pyreverse -p pythermondt.data.datacontainer -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt.data.datacontainer
        pyreverse -p pythermondt.data.units -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt.data.units
        pyreverse -p pythermondt.io -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src pythermondt.io

        # Generate specialized diagrams
        pyreverse -p Node_Hierarchy -o mmd -d ${{ env.MERMAID_DIR }} --colorized --source-roots ./src --filter-mode ALL pythermondt.data.datacontainer.node

    - name: Check for New or Modified Mermaid Files
      id: files-check
      run: |
        if [ "${{ inputs.force_regenerate }}" = "true" ]; then
          echo "Force regenerate enabled - will rebuild all images."
          FILES=$(find ${{ env.MERMAID_DIR }} -name "*.mmd" | tr '\n' ' ')
          echo "CHANGED=true" >> $GITHUB_ENV
        else
          # Get list of new or modified .mmd files (uncommitted changes)
          FILES=$(git status --porcelain ${{ env.MERMAID_DIR }}/*.mmd 2>/dev/null | awk '{print $2}' | tr '\n' ' ' || echo "")

          if [ -n "$FILES" ]; then
            echo "Changed .mmd files detected: $FILES"
            echo "CHANGED=true" >> $GITHUB_ENV
          else
            echo "No changed .mmd files detected."
            echo "CHANGED=false" >> $GITHUB_ENV
          fi
        fi

        # Write files list to step output
        echo "files=$FILES" >> $GITHUB_OUTPUT

    - name: Setup Node.js for Mermaid CLI
      if: env.CHANGED == 'true'
      uses: actions/setup-node@v4.4.0
      with:
        node-version: '20'

    - name: Install Mermaid CLI
      if: env.CHANGED == 'true'
      run: npm install -g @mermaid-js/mermaid-cli

    - name: Generate images from Mermaid files
      if: env.CHANGED == 'true'
      run: |
        # Create puppeteer config for no-sandbox
        echo '{"args":["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]}' > puppeteer-config.json

        FILES="${{ steps.files-check.outputs.files }}"

        for file in $FILES; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .mmd)
            echo "Processing: $file"
            mmdc -i "$file" -o "${{ env.IMAGES_DIR }}/${filename}.png" \
              -b transparent -t neutral -s 5 --puppeteerConfigFile puppeteer-config.json
          fi
        done

    - name: Commit and Push Diagrams back to the repository
      if: env.CHANGED == 'true'
      run: |
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git add ./docs/pyreverse/*
        git commit -m "Update mermaid diagrams"
        git push
