name: Build and Release Conda Package

on:
  workflow_dispatch:
  push:
    branches:
      - "release/*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
    # Step 1: Checkout code in the current branch
    - name: Checkout code
      uses: actions/checkout@v4

    # Step 2: Get release version
    - name: Get Release Version
      id: get_version
      run: |
        # Function to get version from _version.py
        get_version_from_file() {
          VERSION=$(python -c "exec(open('src/pythermondt/__pkginfo__.py').read()); print(__version__)")
          echo $VERSION
        }

        # If triggered by push, check branch name
        if [[ "${{ github.event_name }}" == "push" ]]; then
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          # Check if it's a release branch
          if [[ $BRANCH_NAME != release/* ]]; then
            echo "This is not a release branch. Stopping workflow."
            exit 1
          fi
          
          # Extract version from branch name
          BRANCH_VERSION=$(echo $BRANCH_NAME | sed 's/release\///')
          
          # Get version from file
          FILE_VERSION=$(get_version_from_file)
          
          # Compare versions
          if [[ "$BRANCH_VERSION" != "$FILE_VERSION" ]]; then
            echo "Branch version ($BRANCH_VERSION) does not match version in __pkginfo__.py ($FILE_VERSION)"
            exit 1
          fi
          
          RELEASE_VERSION=$FILE_VERSION
        else
          # For manual triggers, just get version from file
          RELEASE_VERSION=$(get_version_from_file)
        fi

        echo "The release version is $RELEASE_VERSION"
        echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT

    # Step 3: Check if the release already exists
    - name: Check if release exists
      id: check_release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get release info and debug output
        RELEASE_INFO=$(gh release view ${{ steps.get_version.outputs.RELEASE_VERSION }} --json isDraft,isPrerelease,publishedAt --jq '[.isDraft, .isPrerelease, .publishedAt]' 2>&1 || echo "not_found")
        echo "Debug - Release Info: $RELEASE_INFO"
        
        if [[ "$RELEASE_INFO" == *"not_found"* ]]; then
          echo "RELEASE_DOES_NOT_EXIST=true" >> $GITHUB_OUTPUT
        else
          echo "RELEASE_DOES_NOT_EXIST=false" >> $GITHUB_OUTPUT
          
          # Parse the JSON array properly
          IS_DRAFT=$(echo $RELEASE_INFO | jq -r '.[0]')
          IS_PRERELEASE=$(echo $RELEASE_INFO | jq -r '.[1]')
          PUBLISHED_AT=$(echo $RELEASE_INFO | jq -r '.[2]')
          
          echo "Debug - Is Draft: $IS_DRAFT"
          echo "Debug - Is Prerelease: $IS_PRERELEASE"
          echo "Debug - Published At: $PUBLISHED_AT"
          
          # Check if it's a published release (not draft and has a publish date)
          if [[ "$IS_DRAFT" == "false" && "$PUBLISHED_AT" != "null" ]]; then
            echo "IS_PUBLISHED=true" >> $GITHUB_OUTPUT
          else
            echo "IS_PUBLISHED=false" >> $GITHUB_OUTPUT
          fi
          
          echo "IS_DRAFT=$IS_DRAFT" >> $GITHUB_OUTPUT
        fi

    # Step 4: Stop workflow if an official release already exists
    - name: Stop if official release exists
      if: steps.check_release.outputs.IS_PUBLISHED == 'true'
      run: |
        echo "An official release with the tag ${{ steps.get_version.outputs.RELEASE_VERSION }} already exists. Stopping workflow."
        exit 1

    # Step 5: Set up Miniconda
    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v2
      with:
        activate-environment: true
        auto-activate-base: true
        auto-update-conda: true
        channels: conda-forge, defaults
        python-version: 3.12

    # Step 6: Install conda-build
    - name: Install dependencies
      run: |
        conda install conda-build conda-verify -c conda-forge -y
        python -m pip install build twine

    # Step 7: Build the conda package with a specified output folder
    - name: Build conda package
      id: build_package
      run: |
        OUTPUT_DIR="./pyThermoNDT_${{ steps.get_version.outputs.RELEASE_VERSION }}_conda_install_package"
        conda build conda --output-folder $OUTPUT_DIR
        echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_OUTPUT

    # Step 8: Archive the Conda channel directory
    - name: Process the conda package
      id: process_conda
      run: |
        conda index ${{ steps.build_package.outputs.OUTPUT_DIR }}
        echo "Indexed the output directory to make it a valid conda channel."
        ZIP_NAME="pyThermoNDT_${{ steps.get_version.outputs.RELEASE_VERSION }}_conda_install_package.zip"
        zip -r "$ZIP_NAME" ${{ steps.build_package.outputs.OUTPUT_DIR }}
        echo "ARCHIVED_CHANNEL=$ZIP_NAME" >> $GITHUB_OUTPUT
        echo "Zipped the conda channel directory for relase."

    # Step 9: Build pip package
    - name: Build pip package
      id: build_pip
      run: |
        python -m build
        WHEEL_FILE=$(ls dist/*.whl)
        TAR_FILE=$(ls dist/*.tar.gz)
        echo "WHEEL_FILE=$WHEEL_FILE" >> $GITHUB_OUTPUT
        echo "TAR_FILE=$TAR_FILE" >> $GITHUB_OUTPUT

    # Step 10: Delete existing draft release if it exists
    - name: Delete existing draft release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      if: steps.check_release.outputs.RELEASE_DOES_NOT_EXIST == 'false' && steps.check_release.outputs.IS_DRAFT == 'true'
      run: |
       gh release delete ${{ steps.get_version.outputs.RELEASE_VERSION }} --yes

    # Step 11: Create new draft release with all packages
    - name: Create Draft Release
      if: steps.check_release.outputs.RELEASE_DOES_NOT_EXIST == 'true' || steps.check_release.outputs.IS_DRAFT == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.RELEASE_VERSION }}
        name: pyThermoNDT ${{ steps.get_version.outputs.RELEASE_VERSION }}
        body: |
          ## Package Contents
          - Conda Package: Full conda package with all dependencies (for conda installation)
          - Wheel Package (.whl): Python wheel distribution (recommended for pip installation)
          - Source Package (.tar.gz): Source distribution
        files: |
          ${{ steps.process_conda.outputs.CONDA_ARCHIVE }}
          ${{ steps.build_pip.outputs.WHEEL_FILE }}
          ${{ steps.build_pip.outputs.TAR_FILE }}
        generate_release_notes: true
        draft: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}