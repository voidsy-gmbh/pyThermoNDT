name: Prepare Release

on:
  workflow_dispatch:

jobs:
  # Job 1: Create release branch and bump version to release version
  bump-version:
    name: Bump to Release Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      # Step 1: Checkout code with full history
      - name: Checkout code
        uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 0  # Required for tags history
          ssh-key: ${{ secrets.WRITE_KEY }}

      # Step 2: Setup uv
      - name: Setup uv
        uses: astral-sh/setup-uv@v7.1.4
        with:
          version-file: requirements_dev.txt
          python-version: ${{ vars.DEFAULT_PYTHON_VERSION }}
          activate-environment: true
          save-cache: false

      # Step 3: Create release branch and bump version
      - name: Create release branch and bump version
        id: bump
        run: |
          # Setup git user
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          # Install bump-my-version
          uv pip install bump-my-version --overrides ./requirements_dev.txt

          # Get the new release version
          VERSION=$(bump-my-version show --format json --increment release new_version | jq -r .new_version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Create release branch
          git checkout -b release/$VERSION

          # Bump to release version
          bump-my-version bump release --commit

          # Push release branch
          git push origin release/$VERSION

  # Job 2: Update diagrams on the release branch
  update-diagrams:
    name: Update Diagrams
    needs: bump-version
    uses: ./.github/workflows/generate_diagrams.yml
    with:
      ref: release/${{ needs.bump-version.outputs.version }}
      force_regenerate: false
    secrets:
      WRITE_KEY: ${{ secrets.WRITE_KEY }}
